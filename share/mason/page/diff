<p>
  <a href="<% $page->uri() %>"><% loc('Back to current revision') %></a>
</p>

<table class="revision-diff">
  <thead>
    <tr>
      <th class="rev1">
        <% loc( 'Revision [_1]', $rev1->revision_number() ) %>
      </th>
      </th>
      <th class="marker"></th>
      <th class="rev2">
        <% loc( 'Revision [_1]', $rev2->revision_number() ) %>
      </th>
    </tr>
  </thead>
  <tbody>
    <tr class="attribution">
      <td>
        <% loc( 'Created by <a href="%html(%1)">%html(%2)</a> on %3.',
                $rev1->user()->uri(),
                $rev1->user()->best_name(),
                $c->user()->format_datetime( $rev1->creation_datetime() ) ) | n %>
      </td>
      <td></td>
      <td>
        <% loc( 'Created by <a href="%html(%1)">%html(%2)</a> on %3.',
                $rev2->user()->uri(),
                $rev2->user()->best_name(),
                $c->user()->format_datetime( $rev2->creation_datetime() ) ) | n %>
      </td>
    </tr>
  </tbody>
% for my $diff (@diff) {
  <tbody>
%   if ( $diff->[0] eq 'c' ) {
<& .word_diff, diff => $diff->[1] &>
%   } else {
<& .para_diff, diff => $diff &>
%   }
  </tbody>
% }
</table>

<%args>
$page
$rev1
$rev2
@diff
</%args>

<%def .word_diff>
    <tr class="diff-changed">
      <td>
% for my $diff (@diff) {
%   if ( $diff->[0] eq '-' || $diff->[0] eq 'c' ) {
        <del><% $diff->[1] %></del>
%   } elsif ( $diff->[0] eq 'u' ) {
        <% $diff->[1] %>
%   }
% }
      </td>
      <td class="marker">
        <span title="<% loc('paragraph was changed') %>">*</span>
      </td>
      <td>
% for my $diff (@diff) {
%   if ( $diff->[0] eq '+' || $diff->[0] eq 'c' ) {
        <ins><% $diff->[2] %></ins>
%   } elsif ( $diff->[0] eq 'u' ) {
        <% $diff->[1] %>
%   }
% }
      </td>
    </tr>
<%args>
@diff
</%args>
</%def>

<%def .para_diff>
    <tr>
      <td class="<% $diff[0] eq q{-} ? 'diff-removed' : q{} %>">
        <% $diff[1] %>
      </td>
      <td class="marker">
% if ( $diff[0] ne 'u' ) {
        <span title="<% $diff[0] eq '-' ? loc('paragraph was removed') : loc('paragraph was added') %>"><% $diff[0] %></span>
% }
      </td>
      <td class="<% $diff[0] eq q{+} ? 'diff-added' : q{} %>">
        <% $diff[2] %>
      </td>
    </tr>
<%args>
@diff
</%args>
</%def>

<%method title>
<% $page->title() %> - <% loc( 'Revision [_1] versus [_2]', $rev1->revision_number(), $rev2->revision_number() ) %>
<%args>
$page
$rev1
$rev2
</%args>
</%method>
