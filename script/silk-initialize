#!/usr/bin/perl

use strict;
use warnings;

use lib './lib';

use Silki::Config;

system( 'psql', 'template1', '-f', './schema/Silki.sql' )
    and die 'Cannot create Silki database with psql';


require Silki::Model::Domain;

Silki::Model::Domain->EnsureRequiredDomainsExist();

require Silki::Model::User;

Silki::Model::User->EnsureRequiredUsersExist();

print "\n";

my $admin = make_admin_user();
make_first_wiki($admin);

sub make_admin_user
{
    my $email = 'admin@' . Silki::Model::Domain->DefaultDomain()->hostname();
    my $pw = 'changeme';

    my $admin =
        Silki::Model::User->insert( display_name       => 'Angela D. Min',
                                   email_address      => $email,
                                   password           => $pw,
                                   is_admin           => 1,
                                   created_by_user_id => Silki::Model::User->SystemUser()->user_id(),
                                 );

    print <<"EOF";
Created the admin user:

  email:    $email
  password: $pw

EOF
}

sub make_first_wiki
{
    require Silki::Model::Wiki;

    my $wiki =
        Silki::Model::Wiki->insert( title      => 'The First Wiki',
                                   short_name => 'first-wiki',
                                   domain_id  => Silki::Model::Domain->DefaultDomain()->domain_id(),
                                   user_id    => Silki::Model::User->SystemUser()->user_id(),
                                 );

    my $uri = $wiki->base_uri();

    print <<"EOF";
Created the first wiki:

  URI: $uri

EOF

}

